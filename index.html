<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a;
        color: #f8fafc;
        position: relative;
        overflow-x: hidden;
      }

      /* Video Background Styles */
      #bg-video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
        opacity: 0.8;
      }
      /* Custom scrollbar for glass aesthetic */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      h1 {
        color: #00eaff;
      }
      
      .glass-card {
        backdrop-filter: blur(24px);
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border-radius: 1rem;
        padding: 1.5rem;
      }

      .input-field {
        width: 100%;
        background-color: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 0.75rem;
        color: white;
        transition: all 0.2s;
      }
      .input-field:focus {
        outline: none;
        border-color: #60a5fa;
        box-shadow: 0 0 0 1px #60a5fa;
      }
      .input-field::placeholder {
        color: #9ca3af;
      }

      @media (max-width: 768px) {
        h1 {
            font-size: 1.5rem !important; /* Smaller heading for mobile */
        }
        h2 {
          font-size: 1.25rem !important; /* Smaller section titles */
        }
        h3 {
            font-size: 1rem !important; /* Smaller sub-headings */
        }

        p {
          font-size: 0.85rem; /* Readable paragraph text */
        }
        
        .input-field {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }
        
        .input-field::placeholder {
            font-size: 14px; /* Slightly smaller placeholder text */
            line-height: 1.5;
        }

        /* Adjust input font size to prevent zoom on focus in iOS */
        input, select, textarea {
            font-size: 16px !important; 
        }
      }

      /* Print Styles */
      @media print {
        @page { margin: 0; }
        body { background: rgb(255, 255, 255); color: black;
          print-color-adjust: exact;
           -webkit-print-color-adjust: exact; }
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        .glass-panel, .glass-card {
          background: white !important;
          border: none !important;
          box-shadow: none !important;
          backdrop-filter: none !important;
          color: black !important;
          padding: 0 !important;
        }
        .text-white { color: black !important; }
        .text-gray-300 { color: #4b5563 !important; }
        .text-gray-200 { color: #374151 !important; }
        .text-blue-300 { color: #2563eb !important; }
        .bg-white\/10 { background: transparent !important; }
        .border-white\/20 { border-color: #e5e7eb !important; }
        
        #resume-document {
          box-shadow: none !important;
          margin: 0 !important;
          width: 100% !important;
          max-width: none !important;
          padding: 20px 40px !important;
        }
      }
    </style>
  </head>
  <body class="selection:bg-blue-500 selection:text-white">
    
    <!-- Video Background -->
    <video id="bg-video" autoplay muted loop playsinline>
      <source src="bg.mp4" type="video/mp4">
    </video>
    
    <!-- Dynamic Background Elements -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden no-print">
      <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-500/20 rounded-full blur-[100px] animate-pulse"></div>
      <div class="absolute bottom-[10%] right-[-5%] w-[30%] h-[30%] bg-blue-500/20 rounded-full blur-[100px] animate-pulse delay-1000"></div>
      <div class="absolute top-[40%] left-[60%] w-[20%] h-[20%] bg-cyan-500/20 rounded-full blur-[80px]"></div>
    </div>
    <div class="fixed inset-0 z-0 opacity-20 pointer-events-none no-print" 
         style="background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 30px 30px">
    </div>

    <!-- Main App -->
    <div class="relative z-10 p-4 md:p-8">
      
      <!-- Header -->
      <header class="max-w-7xl mx-auto flex justify-between items-center mb-10 no-print">
        <div class="flex items-center gap-2">
          <div class="relative">
             <img src="logo.png" alt="Logo" class="w-10 h-16 object-contain" />
          </div>
          <div>
            <h1 class="text-2xl font-bold tracking-tight">Partho's Resume Builder</h1>
            <span class="text-xs text-yellow-300 uppercase tracking-widest">Next-Gen Applicant Tracking System Builder</span>
          </div>
        </div>
        <div class="hidden sm:block text-right">
           <p class="text-xs text-gray-400">Powered by Gemini 2.5 Flash</p>
        </div>
      </header>

      <!-- Content Container -->
      <main class="max-w-7xl mx-auto">
        
        <!-- Error Display -->
        <div id="error-box" class="hidden mb-6 p-4 rounded-lg bg-red-500/10 border border-red-500/30 text-red-200 text-center backdrop-blur-md"></div>

        <!-- FORM SECTION -->
        <div id="form-section" class="max-w-3xl mx-auto space-y-6">
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-200 to-aqua-200">
              Build Your <strong class="text-greenyellow-200">Resume</strong>
            </h2>
            <p class="text-blue-200/60 mt-2">Enter your details to get a perfect ATS-optimized <strong>Resume</strong>.</p>
          </div>

          <!-- Personal Info -->
          <div class="glass-card">
            <div class="flex items-center gap-2 mb-4 text-blue-300">
              <i data-lucide="user" class="w-5 h-5"></i>
              <h3 class="font-semibold text-lg">Personal Details</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" id="full_name" placeholder="Full Name (Required)" class="input-field border-blue-500/50" />
              <input type="text" id="target_role" placeholder="Target Role (Required)" class="input-field border-blue-500/50" value="Frontend Developer" />
              <input type="email" id="email" placeholder="Email" class="input-field" />
              <input type="tel" id="phone" placeholder="Phone Number" class="input-field" />
              <input type="text" id="linkedin" placeholder="LinkedIn URL" class="input-field" />
              <input type="text" id="portfolio" placeholder="Portfolio / Github URL" class="input-field" />
            </div>
            <div class="mt-4">
              <label for="profile_image" class="flex items-center gap-2 text-sm text-blue-300 mb-2">
                <i data-lucide="image" class="w-4 h-4"></i>
                <span>Profile Image (Optional)</span>
              </label>
              <input type="file" id="profile_image" accept="image/*" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500/20 file:text-blue-300 hover:file:bg-blue-500/30 file:cursor-pointer" />
              <p class="text-xs text-gray-400 mt-1">Upload a professional photo (JPG, PNG). Image will appear at top-right of resume.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex gap-4">
                <select id="experience_level" class="input-field flex-1 [&>option]:text-black">
                  <option value="Fresher">Fresher</option>
                  <option value="Experienced" selected>Experienced</option>
                </select>
                <input type="text" id="years_of_experience" placeholder="Years (e.g., 5)" class="input-field flex-1" />
              </div>
            </div>
          </div>

          <!-- Experience -->
          <div class="glass-card">
            <div class="flex items-center gap-2 mb-4 text-blue-300">
              <i data-lucide="briefcase" class="w-5 h-5"></i>
              <h3 class="font-semibold text-lg">Experience & Education</h3>
            </div>
            
            <div id="experience-list" class="space-y-4 mb-4">
              <!-- Dynamic Experience Entries will be added here -->
            </div>
            
            <button id="add-experience-btn" class="w-full py-2 border-2 border-dashed border-blue-500/30 rounded-lg text-blue-300/70 hover:text-blue-200 hover:border-blue-500/50 hover:bg-blue-500/10 transition flex items-center justify-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i>
              <span>Add Experience</span>
            </button>

            <div class="space-y-4 mt-6">
              <textarea id="projects_raw" rows="3" placeholder="Paste your Projects details here. Title, Tech Stack, Description." class="input-field"></textarea>
              <div class="flex items-center gap-2 mt-4 text-blue-300">
                <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                <span class="font-semibold">Education</span>
              </div>
              <input type="text" id="education" placeholder="e.g., B.Tech in Computer Science, XYZ University, 2020" class="input-field" />
            </div>
          </div>

          <!-- Skills -->
          <div class="glass-card">
            <div class="flex items-center gap-2 mb-4 text-blue-300">
              <i data-lucide="code" class="w-5 h-5"></i>
              <h3 class="font-semibold text-lg">Skills & Target</h3>
            </div>
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-blue-300 mb-1 ml-1">Core Technologies</label>
                  <input type="text" id="skills_core" placeholder="e.g. HTML, CSS, JavaScript, TypeScript" class="input-field" />
                </div>
                <div>
                  <label class="block text-xs text-blue-300 mb-1 ml-1">Frameworks & Libraries</label>
                  <input type="text" id="skills_frameworks" placeholder="e.g. React, Vue, Next.js, Tailwind" class="input-field" />
                </div>
                <div>
                  <label class="block text-xs text-blue-300 mb-1 ml-1">Tools & Platforms</label>
                  <input type="text" id="skills_tools" placeholder="e.g. Git, Docker, AWS, VS Code" class="input-field" />
                </div>
                <div>
                  <label class="block text-xs text-blue-300 mb-1 ml-1">UI/UX & Design</label>
                  <input type="text" id="skills_uiux" placeholder="e.g. Figma, Photoshop, Responsive Design" class="input-field" />
                </div>
              </div>

              <div class="flex items-center gap-2 mt-4 text-blue-300">
                 <i data-lucide="file-text" class="w-5 h-5"></i>
                 <span class="font-semibold">Job Description (For ATS Optimization)</span>
              </div>
              <textarea id="job_description" rows="4" placeholder="Paste the Job Description you are applying for. The AI will optimize keywords for this specific role." class="input-field"></textarea>
            </div>
          </div>

          <!-- Generate Button -->
          <div class="flex justify-center pt-4 pb-12">
            <button id="generate-btn" class="relative group flex items-center gap-3 px-8 py-4 font-bold text-lg bg-gray-800/60 shadow-lg shadow-blue-500/30 transition-all duration-300 hover:scale-105 hover:shadow-blue-500/70 disabled:opacity-50 disabled:cursor-not-allowed">
              <span id="btn-spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
              <i id="btn-icon" data-lucide="send" class="w-5 h-5 text-yellow-200"></i>
              <span id="btn-text" class="text-yellow-200">Generate Resume</span>
              <div class="absolute inset-0 rounded-full bg-white/20 blur-md opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </button>
          </div>
        </div>

        <!-- PREVIEW SECTION (Hidden initially) -->
        <div id="preview-section" class="hidden max-w-5xl mx-auto space-y-8 pb-12">
          
          <!-- Actions -->
          <div class="flex flex-col sm:flex-row justify-between items-center gap-4 no-print">
            <button id="back-btn" class="flex items-center gap-2 text-white/70 hover:text-white transition">
              <i data-lucide="arrow-left" class="w-5 h-5"></i>
              Back to Editor
            </button>
            <button id="print-btn" class="flex items-center gap-2 px-6 py-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-white transition backdrop-blur-md">
              <i data-lucide="download" class="w-[18px] h-[18px]"></i>
              Download PDF
            </button>
          </div>

          <!-- Stats & Suggestions -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 no-print">
            <!-- ATS Score -->
            <div class="glass-card col-span-1 flex flex-col items-center justify-center text-center">
              <h3 class="text-lg font-medium text-blue-200 mb-4">ATS Score</h3>
              <div class="w-full h-8 bg-slate-700 rounded-full overflow-hidden relative">
                <div id="score-bar" class="h-full transition-all duration-1000 ease-out bg-green-400" style="width: 0%"></div>
              </div>
              <div id="score-value" class="text-4xl font-bold text-white mt-4">0/100</div>
            </div>

            <!-- Improvements -->
            <div class="glass-card col-span-1 md:col-span-2">
              <div class="flex items-center gap-2 text-yellow-300 mb-4">
                 <i data-lucide="trending-up" class="w-5 h-5"></i>
                 <h3 class="text-lg font-medium">Improvement Suggestions</h3>
              </div>
              <ul id="suggestions-list" class="space-y-2"></ul>
            </div>
          </div>

          <!-- Resume Document -->
          <div id="resume-document" class="bg-[#b7ffff] text-gray-800 p-8 md:p-12 shadow-2xl mx-auto rounded-sm max-w-[210mm] min-h-[297mm]">
             <!-- Content injected via JS -->
          </div>
        </div>

      </main>

      <footer class="text-center mt-20 text-gray-500 text-sm no-print">
        <p>&copy; <span id="year"></span> GlassResume AI. Built for Frontend Engineers | With ðŸ’– from <strong>Partho</strong></p>
      </footer>
    </div>

    <!-- Application Script -->
    <script>
      // --- NO API KEY REQUIRED - CLIENT-SIDE ONLY ---
      
      let uploadedImageData = null; // Store uploaded image data

      // --- DOM ELEMENTS ---
      const els = {
        formSection: document.getElementById('form-section'),
        previewSection: document.getElementById('preview-section'),
        errorBox: document.getElementById('error-box'),
        generateBtn: document.getElementById('generate-btn'),
        btnSpinner: document.getElementById('btn-spinner'),
        btnIcon: document.getElementById('btn-icon'),
        btnText: document.getElementById('btn-text'),
        backBtn: document.getElementById('back-btn'),
        printBtn: document.getElementById('print-btn'),
        experienceList: document.getElementById('experience-list'),
        addExperienceBtn: document.getElementById('add-experience-btn'),
        inputs: {
          full_name: document.getElementById('full_name'),
          target_role: document.getElementById('target_role'),
          email: document.getElementById('email'),
          phone: document.getElementById('phone'),
          linkedin: document.getElementById('linkedin'),
          portfolio: document.getElementById('portfolio'),
          experience_level: document.getElementById('experience_level'),
          years_of_experience: document.getElementById('years_of_experience'),
          projects_raw: document.getElementById('projects_raw'),
          education: document.getElementById('education'),
          skills_core: document.getElementById('skills_core'),
          skills_frameworks: document.getElementById('skills_frameworks'),
          skills_tools: document.getElementById('skills_tools'),
          skills_uiux: document.getElementById('skills_uiux'),
          job_description: document.getElementById('job_description'),
          profile_image: document.getElementById('profile_image')
        },
        resumeDoc: document.getElementById('resume-document'),
        scoreBar: document.getElementById('score-bar'),
        scoreValue: document.getElementById('score-value'),
        suggestionsList: document.getElementById('suggestions-list'),
        year: document.getElementById('year')
      };

      if (els.year) els.year.textContent = new Date().getFullYear();

      // --- IMAGE UPLOAD HANDLER ---
      if (els.inputs.profile_image) {
        els.inputs.profile_image.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              uploadedImageData = event.target.result;
              console.log('Image uploaded successfully');
            };
            reader.readAsDataURL(file);
          }
        });
      }

      // --- EXPERIENCE INPUT HANDLER ---
      function createExperienceEntry() {
        const id = Date.now();
        const div = document.createElement('div');
        div.className = "bg-white/5 p-4 rounded-lg border border-white/10 relative group";
        div.dataset.id = id;
        
        div.innerHTML = `
          <button type="button" class="absolute top-2 right-2 text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity" onclick="removeExperienceEntry(${id})">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <input type="text" placeholder="Job Title (e.g. Frontend Developer)" class="exp-role input-field text-sm" />
            <input type="text" placeholder="Company Name" class="exp-company input-field text-sm" />
          </div>
          <div class="mb-3">
            <input type="text" placeholder="Duration (e.g. Jan 2022 - Present)" class="exp-duration input-field text-sm" />
          </div>
          <textarea rows="3" placeholder="Key responsibilities and achievements (bullet points recommended)" class="exp-description input-field text-sm"></textarea>
        `;
        
        return div;
      }

      function addExperienceEntry() {
        const entry = createExperienceEntry();
        els.experienceList.appendChild(entry);
        if (window.lucide) window.lucide.createIcons();
      }

      window.removeExperienceEntry = function(id) {
        const entry = els.experienceList.querySelector(`div[data-id="${id}"]`);
        if (entry) entry.remove();
      };

      // Add one empty entry by default
      if (els.experienceList && els.experienceList.children.length === 0) {
        addExperienceEntry();
      }

      if (els.addExperienceBtn) {
        els.addExperienceBtn.addEventListener('click', addExperienceEntry);
      }

      function getExperienceData() {
        const entries = [];
        const entryDivs = els.experienceList.querySelectorAll('div[data-id]');
        
        entryDivs.forEach(div => {
          const role = div.querySelector('.exp-role').value.trim();
          const company = div.querySelector('.exp-company').value.trim();
          const duration = div.querySelector('.exp-duration').value.trim();
          const description = div.querySelector('.exp-description').value.trim();
          
          if (role || company) {
            // Split description into bullets
            const bullets = description.split('\n').map(b => b.trim()).filter(b => b);
            // Clean up bullets (remove leading dashes/dots if user added them)
            const cleanBullets = bullets.map(b => b.replace(/^[-â€¢*]\s*/, ''));
            
            entries.push({
              role: role || 'Job Title',
              company: company || 'Company',
              duration: duration || '',
              bullets: cleanBullets.length > 0 ? cleanBullets : ['Key responsibilities']
            });
          }
        });
        
        return entries;
      }

      // --- HELPERS ---
      function setLoading(isLoading) {
        if (!els.generateBtn) return;
        els.generateBtn.disabled = isLoading;
        if (isLoading) {
          els.btnSpinner.classList.remove('hidden');
          els.btnIcon.classList.add('hidden');
          els.btnText.textContent = "Generating Resume...";
          els.errorBox.classList.add('hidden');
        } else {
          els.btnSpinner.classList.add('hidden');
          els.btnIcon.classList.remove('hidden');
          els.btnText.textContent = "Generate Resume";
        }
      }

      function showError(msg) {
        if (!els.errorBox) return;
        els.errorBox.textContent = msg;
        els.errorBox.classList.remove('hidden');
        els.formSection.scrollIntoView({ behavior: 'smooth' });
      }

      function toggleView(showPreview) {
        if (showPreview) {
          els.formSection.classList.add('hidden');
          els.previewSection.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          els.formSection.classList.remove('hidden');
          els.previewSection.classList.add('hidden');
        }
      }

      // --- CLIENT-SIDE PARSING FUNCTIONS ---
      // (parseWorkExperience removed - using direct input now)


      // --- CLIENT-SIDE PARSING FUNCTIONS ---
      // (parseWorkExperience removed - using direct input now)

      function parseProjects(rawText) {
        if (!rawText) return [];
        
        const entries = rawText.split(/\n\n+|\d+\.\s*/).filter(e => e.trim());
        
        return entries.map(entry => {
          const lines = entry.split('\n').map(l => l.trim()).filter(l => l);
          if (lines.length === 0) return null;
          
          return {
            title: lines[0] || 'Project Name',
            tech_stack: lines.find(l => l.toLowerCase().includes('tech') || l.includes(',')) || 'Technologies Used',
            bullets: lines.slice(1)
          };
        }).filter(e => e !== null);
      }

      function parseSkills(inputData) {
        const parseList = (str) => {
          if (!str) return [];
          return str.split(/[,;]\s*/).map(s => s.trim()).filter(s => s);
        };

        return {
          technical: parseList(inputData.skills_core),
          frameworks_libraries: parseList(inputData.skills_frameworks),
          tools_platforms: parseList(inputData.skills_tools),
          ui_ux_design: parseList(inputData.skills_uiux),
          soft_skills: []
        };
      }

      function generateCareerSummary(inputData) {
        const years = inputData.years_of_experience || '0';
        const role = inputData.target_role || 'Frontend Developer';
        const level = inputData.experience_level || 'Experienced';
        
        if (level === 'Fresher') {
          return `Motivated ${role} with a strong foundation in modern web technologies. Passionate about creating responsive, user-friendly web applications with clean code and attention to detail.`;
        } else {
          return `${level} ${role} with ${years}+ years of experience in developing responsive web applications. Expertise in modern frontend technologies, UI/UX implementation, and delivering high-quality, scalable solutions.`;
        }
      }

      function analyzeJobFit(inputData, workExperienceData, parsedSkills, parsedProjects) {
         if (!inputData.job_description) return null;

         const jdText = inputData.job_description.toLowerCase();
         // Keyword extraction (words > 2 chars, ignoring common stop words)
         const stopWords = ['and', 'or', 'the', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'an', 'is', 'it', 'as', 'be', 'by', 'if', 'we', 'us', 'do', 'so', 'my', 'me', 'up', 'he', 'hi', 'no', 'will', 'that', 'this', 'from', 'have', 'has', 'had', 'not', 'are', 'was', 'were', 'been', 'being', 'can', 'could', 'would', 'should', 'may', 'might', 'must', 'experience', 'knowledge', 'understanding', 'proficiency', 'ability', 'strong', 'good', 'excellent', 'work', 'working', 'team', 'skills', 'years', 'looking', 'candidate', 'role', 'job', 'description', 'responsibilities', 'qualifications', 'requirements', 'preferred', 'plus', 'nice'];
         const rawKeywords = jdText.match(/\b[a-z0-9+#]{2,}\b/g) || [];
         
         // Filter keywords
         const keywords = [...new Set(rawKeywords.filter(w => !stopWords.includes(w)))];
         
         // If text exists but no keywords found, return object with empty lists so we can show a message
         if (keywords.length === 0) {
             return { keywords: [], matched: [], missing: [], score_boost: 0, text_too_short: true };
         }

         // Build resume text corpus
         let resumeCorpus = (inputData.target_role || '') + ' ' + (inputData.career_summary || '');
         
         // Add skills
         Object.values(parsedSkills).forEach(arr => resumeCorpus += ' ' + arr.join(' '));
         
         // Add experience
         workExperienceData.forEach(job => {
            resumeCorpus += ' ' + job.role + ' ' + job.company + ' ' + (job.bullets ? job.bullets.join(' ') : '');
         });

         // Add projects
         parsedProjects.forEach(p => {
            resumeCorpus += ' ' + p.title + ' ' + p.tech_stack + ' ' + p.bullets.join(' ');
         });
         
         resumeCorpus = resumeCorpus.toLowerCase();

         const matched = [];
         const missing = [];

         keywords.forEach(k => {
            if (resumeCorpus.includes(k)) {
                matched.push(k);
            } else {
                missing.push(k);
            }
         });

         return {
            keywords,
            matched,
            missing,
            score_boost: Math.floor((matched.length / keywords.length) * 20), // Up to 20 points boost
            text_too_short: false
         };
      }

      function calculateATSScore(inputData, workExperienceData, jobFit) {
        let score = 50; // Base score
        
        // Add points for filled fields
        if (inputData.email) score += 5;
        if (inputData.phone) score += 5;
        if (inputData.linkedin || inputData.portfolio) score += 5;
        
        // Work experience
        if (workExperienceData && workExperienceData.length > 0) {
           score += 15;
           const totalBullets = workExperienceData.reduce((acc, job) => acc + (job.bullets ? job.bullets.length : 0), 0);
           if (totalBullets > 5) score += 5;
        }

        if (inputData.projects_raw && inputData.projects_raw.length > 50) score += 10;
        
        // Skills
        if (inputData.skills_core) score += 5;
        if (inputData.skills_frameworks) score += 5;
        
        if (inputData.education) score += 5;
        
        // Job Fit Boost
        if (jobFit && jobFit.score_boost) {
            score += jobFit.score_boost;
        }
        
        return Math.min(score, 100); 
      }

      function generateSuggestions(inputData, score, workExperienceData, jobFit) {
        const suggestions = [];
        
        if (jobFit) {
            if (jobFit.text_too_short) {
                 suggestions.push("The Job Description text is too short or generic to extract keywords.");
            } else if (jobFit.missing.length > 0) {
                // Show top 3 missing keywords
                const topMissing = jobFit.missing.slice(0, 5).join(', ');
                suggestions.push(`Consider adding these missing keywords from the JD: <strong>${topMissing}</strong>`);
            } else if (jobFit.matched.length > 0) {
                 suggestions.push("Great job! Your resume matches the Job Description keywords well.");
            }
        } else if (!inputData.job_description) {
            suggestions.push("Paste a Job Description to get keyword optimization suggestions.");
        }

        if (!inputData.email || !inputData.phone) {
          suggestions.push("Add complete contact information (email and phone) for better reachability.");
        }
        if (score < 70 && (!jobFit || jobFit.score_boost < 10)) {
          suggestions.push("Add more detailed work experience or skills to increase your score.");
        }
        
        if (inputData.skills_core && inputData.skills_core.split(',').length < 3) {
            suggestions.push("List more Core Technologies.");
        }

        // Add generic suggestions if needed
        if (suggestions.length < 3) {
          suggestions.push("Use action verbs (e.g. 'Developed', 'Led') in your experience bullets.");
          suggestions.push("Quantify achievements (e.g. 'Improved performance by 20%').");
        }
        
        return suggestions.slice(0, 4);
      }

      // --- GENERATE LOGIC ---
      async function generateResume() {
        console.log("Generate Resume Clicked");

        // 1. Validation
        const inputData = {};
        for (const key in els.inputs) {
          if (els.inputs[key]) {
             inputData[key] = els.inputs[key].value.trim();
          }
        }

        if (!inputData.full_name || !inputData.target_role) {
          showError("Please enter at least your Name and Target Role.");
          return;
        }

        setLoading(true);
        await new Promise(resolve => setTimeout(resolve, 800));

        try {
          const workExperience = getExperienceData();
          const parsedSkills = parseSkills(inputData);
          const parsedProjects = parseProjects(inputData.projects_raw);
          
          // Analyze fit
          const jobFit = analyzeJobFit(inputData, workExperience, parsedSkills, parsedProjects);
          
          const resumeData = {
            career_summary: generateCareerSummary(inputData),
            work_experience: workExperience,
            projects: parsedProjects,
            skills: parsedSkills,
            ats_score: calculateATSScore(inputData, workExperience, jobFit),
            improvement_suggestions: generateSuggestions(inputData, 0, workExperience, jobFit),
            job_fit: jobFit
          };
          
          // Render
          renderResumeData(resumeData, inputData);
          
          // Render extra job fit info if available
          if (jobFit && els.suggestionsList) {
             const fitHtml = `
                <li class="flex items-start gap-2 text-sm text-green-300 mt-2 pt-2 border-t border-white/10">
                    <i data-lucide="check-circle" class="w-4 h-4 mt-0.5 shrink-0"></i>
                    <span>Matched Keywords: ${jobFit.matched.slice(0, 8).join(', ')}${jobFit.matched.length > 8 ? '...' : ''}</span>
                </li>
             `;
             els.suggestionsList.insertAdjacentHTML('beforeend', fitHtml);
          }

          toggleView(true);

        } catch (err) {
          console.error("Error during generation:", err);
          showError("Failed to generate resume. " + (err.message || "Unknown error"));
        } finally {
          setLoading(false);
        }
      }

      function renderResumeData(data, userInput) {
        // 1. Stats
        const score = data.ats_score || 0;
        if (els.scoreValue) els.scoreValue.textContent = `${score}/100`;
        if (els.scoreBar) {
            els.scoreBar.style.width = `${score}%`;
            els.scoreBar.className = `h-full transition-all duration-1000 ease-out ${score > 80 ? 'bg-green-400' : score > 60 ? 'bg-yellow-400' : 'bg-red-400'}`;
        }

        if (els.suggestionsList && data.improvement_suggestions) {
            els.suggestionsList.innerHTML = data.improvement_suggestions.map(s => `
              <li class="flex items-start gap-2 text-sm text-gray-300">
                <i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0 text-yellow-500/70"></i>
                <span>${s}</span>
              </li>
            `).join('');
        }

        // 2. Resume Document
        // Header
        let html = `
          <header class="border-b-4 border-gray-800 pb-6 mb-6 relative">
            ${uploadedImageData ? `<div class="absolute top-0 right-0"><img src="${uploadedImageData}" alt="Profile Photo" class="w-28 h-28 object-cover rounded-lg" /></div>` : ''}
            <h1 class="text-4xl font-bold text-gray-900 uppercase tracking-wide ${uploadedImageData ? 'pr-32' : ''}">${userInput.full_name || 'Candidate Name'}</h1>
            <p class="text-xl text-gray-600 font-medium mt-1 ${uploadedImageData ? 'pr-32' : ''}">${userInput.target_role || 'Job Role'}</p>
            <div class="flex flex-wrap gap-4 mt-4 text-sm text-gray-600 ${uploadedImageData ? 'pr-32' : ''}">
               ${userInput.email ? `<span>${userInput.email}</span>` : ''}
               ${userInput.phone ? `<span class="border-l border-gray-400 pl-4">${userInput.phone}</span>` : ''}
               ${userInput.linkedin ? `<span class="border-l border-gray-400 pl-4">${userInput.linkedin}</span>` : ''}
               ${userInput.portfolio ? `<span class="border-l border-gray-400 pl-4">${userInput.portfolio}</span>` : ''}
            </div>
          </header>
        `;

        // Summary
        if (data.career_summary) {
            html += `
              <section class="mb-6">
                 <h2 class="text-lg font-bold text-gray-800 uppercase border-b border-gray-300 pb-1 mb-3">Professional Summary</h2>
                 <p class="text-gray-700 leading-relaxed text-sm">${data.career_summary}</p>
              </section>
            `;
        }

        // Skills
        const skills = data.skills;
        if (skills) {
            html += `
              <section class="mb-6">
                 <h2 class="text-lg font-bold text-gray-800 uppercase border-b border-gray-300 pb-1 mb-3">Technical Skills</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-y-2 text-sm">
                    <div class="flex gap-2"><span class="font-semibold text-gray-900 w-32 shrink-0">Core:</span><span class="text-gray-700">${(skills.technical || []).join(', ')}</span></div>
                    <div class="flex gap-2"><span class="font-semibold text-gray-900 w-32 shrink-0">Frameworks:</span><span class="text-gray-700">${(skills.frameworks_libraries || []).join(', ')}</span></div>
                    <div class="flex gap-2"><span class="font-semibold text-gray-900 w-32 shrink-0">Tools:</span><span class="text-gray-700">${(skills.tools_platforms || []).join(', ')}</span></div>
                    <div class="flex gap-2"><span class="font-semibold text-gray-900 w-32 shrink-0">UI/UX:</span><span class="text-gray-700">${(skills.ui_ux_design || []).join(', ')}</span></div>
                 </div>
              </section>
            `;
        }

        // Work Experience
        if (data.work_experience && data.work_experience.length > 0) {
            html += `
              <section class="mb-6">
                 <h2 class="text-lg font-bold text-gray-800 uppercase border-b border-gray-300 pb-1 mb-3">Work Experience</h2>
                 <div class="space-y-5">
                   ${data.work_experience.map(job => `
                     <div>
                       <div class="flex justify-between items-baseline mb-1">
                         <h3 class="font-bold text-gray-900 text-base">${job.role}</h3>
                         <span class="text-sm text-gray-600 font-medium">${job.duration}</span>
                       </div>
                       <div class="text-gray-700 font-medium italic mb-2 text-sm">${job.company}</div>
                       <ul class="list-disc list-outside ml-4 space-y-1">
                         ${(job.bullets || []).map(b => `<li class="text-sm text-gray-700 leading-relaxed pl-1">${b}</li>`).join('')}
                       </ul>
                     </div>
                   `).join('')}
                 </div>
              </section>
            `;
        }

        // Projects
        if (data.projects && data.projects.length > 0) {
          html += `
            <section class="mb-6">
              <h2 class="text-lg font-bold text-gray-800 uppercase border-b border-gray-300 pb-1 mb-3">Key Projects</h2>
              <div class="space-y-4">
                ${data.projects.map(p => `
                  <div>
                    <div class="flex justify-between items-baseline mb-1">
                      <h3 class="font-bold text-gray-900 text-base">${p.title}</h3>
                    </div>
                    <div class="text-xs text-gray-500 mb-1 font-mono">${p.tech_stack}</div>
                    <ul class="list-disc list-outside ml-4 space-y-1">
                      ${(p.bullets || []).map(b => `<li class="text-sm text-gray-700 leading-relaxed pl-1">${b}</li>`).join('')}
                    </ul>
                  </div>
                `).join('')}
              </div>
            </section>
          `;
        }

        // Education
        if (userInput.education) {
            html += `
              <section>
                <h2 class="text-lg font-bold text-gray-800 uppercase border-b border-gray-300 pb-1 mb-3">Education</h2>
                <p class="text-gray-700 text-sm font-medium">${userInput.education}</p>
              </section>
            `;
        }

        if (els.resumeDoc) els.resumeDoc.innerHTML = html;
        
        // Refresh icons
        if (window.lucide) window.lucide.createIcons();
      }

      // --- EVENTS ---
      if (els.generateBtn) els.generateBtn.addEventListener('click', generateResume);
      if (els.backBtn) els.backBtn.addEventListener('click', () => toggleView(false));
      if (els.printBtn) els.printBtn.addEventListener('click', () => window.print());

      // Initial Icons
      if (window.lucide) window.lucide.createIcons();
    </script>
  </body>

</html>
